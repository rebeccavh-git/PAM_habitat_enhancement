---
title: "dusk_spl_repeatedmeasuresANOVA"
author: "Becca Van Hoeck"
date: "May 5, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Revised Analysis: 05/10/2021

Currently using two-way repeated measures ANOVA, followed by post-hoc pairwise comparisons
This accounts for the temporal autocorrelation, but likely doesn't account for pseudoreplication

```{r}
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(rstatix)

```

# Low Frequency

```{r}
spl_table = read.csv("C:/Users/Becca/Documents/git/PAM_Habitat_Enhancement/low_dusk_spl_table_time_02-21.csv", header = TRUE)
spl_table$hour = as.factor(spl_table$hour)
spl_table$site = as.factor(spl_table$site)
spl_table$deploy = as.factor(spl_table$deploy)

# Two-way Repeated measures ANOVA:

# Examine data
spl_table %>%
  group_by(site, deploy) %>%
  get_summary_stats(spl_db, type = "mean_sd")

# Check for outliers
spl_table %>%
  group_by(site, deploy) %>%
  identify_outliers(spl_db) # one outlier, but not extreme

# Check normality
spl_table %>%
  group_by(site,deploy) %>%
  shapiro_test(spl_db) # Indra April and JJ Tug Dec violate normality

ggqqplot(spl_table, "spl_db", ggtheme = theme_bw()) +
  facet_grid(deploy ~ site, labeller = "label_both") # pass normality test with qqplot

# Conduct ANOVA  
res.aov.low <- anova_test(
  data = spl_table, dv = spl_db, wid = hour,
  within = c(site, deploy)
  )
get_anova_table(res.aov.low)

### identified a significant effect of site, deployment and their interaction. Deployment has the largest generalized effect size

# Effect of site at each time point
one.way <- spl_table %>%
  group_by(deploy) %>%
  anova_test(dv = spl_db, wid = hour, within = site) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")
one.way
### Identified significant differences in all deployments except April (final deployment)

# Pairwise comparison between sites
pwc.low <- spl_table %>%
  group_by(deploy) %>%
  pairwise_t_test(
    spl_db ~ site, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc.low
### New reef (JJTug) is significantly louder in September
### New Reef and Established reef are the same in April


# Boxplot
lf_spl = ggplot(spl_table, aes(x = deploy, y = spl_db, fill = site))+ theme_bw()+
  geom_boxplot()+ #facet_wrap("Site")
  scale_fill_manual(values=c("gray71", "firebrick2"), )+
  scale_y_continuous(breaks=seq(90,120,5))+
  labs(x = "Deployment", y = expression("Dusk SPL (dB re 1 "*{mu}*"Pa)"))+
  theme(axis.text = element_text(size = 14), 
        strip.text = element_text(size = 16), 
        axis.title = element_text(size = 16), 
        legend.position = "none") 
        
lf_spl

```

# High Frequency

```{r}
spl_table_high = read.csv("high_dusk_spl_table_time_02-21.csv", header = TRUE)
spl_table_high$hour = as.factor(spl_table_high$hour)
spl_table_high$site = as.factor(spl_table_high$site)
spl_table_high$deploy = as.factor(spl_table_high$deploy)


# testing two-way Repeated measures: 
spl_table_high %>%
  group_by(site, deploy) %>%
  get_summary_stats(spl_db, type = "mean_sd")

spl_table_high %>%
  group_by(site, deploy) %>%
  identify_outliers(spl_db) # one outlier, but not extreme

spl_table_high %>%
  group_by(site,deploy) %>%
  shapiro_test(spl_db) # Indra April and JJ Tug Dec violate normality

ggqqplot(spl_table_high, "spl_db", ggtheme = theme_bw()) +
  facet_grid(deploy ~ site, labeller = "label_both") # pass normality test with qqplot

# Conduct ANOVA  
# is pseudoreplication still a concern?
res.aov.high <- anova_test(
  data = spl_table_high, dv = spl_db, wid = hour,
  within = c(site, deploy)
  )
get_anova_table(res.aov.high)

# Effect of site at each time point
one.way.high <- spl_table_high %>%
  group_by(deploy) %>%
  anova_test(dv = spl_db, wid = hour, within = site) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")
one.way.high

# Pairwise comparison between sites
pwc.high <- spl_table_high %>%
  group_by(deploy) %>%
  pairwise_t_test(
    spl_db ~ site, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc.high



# USe this to describe colonization trajectory of snapping shrimp
# Effect of time at each level of treatment
one.way2.high <- spl_table_high %>%
  group_by(site) %>%
  anova_test(dv = spl_db, wid = hour, within = deploy) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")

# Pairwise comparisons between time points 
# doesn't work because 1 deployment has 8 samples instead of 7
pwc2.high <- spl_table_high %>%
  group_by(site) %>%
  pairwise_t_test(
    spl_db ~ deploy, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
pwc2.high


hf_spl = ggplot(spl_table_high, aes(x = deploy, y = spl_db, fill = site))+ theme_bw()+
  geom_boxplot()+ #facet_wrap("Site")
  scale_fill_manual(values=c("gray71", "firebrick2"), )+
  labs(x = "Deployment", y = expression("Dusk SPL (dB re 1 "*{mu}*"Pa)"))+ 
  theme(axis.text = element_text(size = 14), 
        strip.text = element_text(size = 16), 
        axis.title = element_text(size = 16), 
        legend.position = c(0.9, 0.15))
hf_spl

```

